#!/bin/bash
# shellcheck disable=SC1091,SC2155,SC2068

source "${BASH_SOURCE%/*}/.helpers.sh"

set -e

ensure_pwd_is_top_level

export GIT_USER_ID=danicc097
export GIT_REPO_ID=openapi-go-gin-postgres-sqlc
export GO_POST_PROCESS_FILE="/usr/bin/env gofmt -w -s"
export GENVERS=6.0.1

SPEC="openapi.yaml"
GEN_OUT_DIR="internal"
TEMPLATE_DIR="internal/go-gin-server-templates"
PWD="$(pwd)"
ENV_FILE=".env"
BIN_DIR=$(dirname "$0")

################# prerequisites #################

x.check.build-deps() {
  local -i fails
  x.check.bash || (echo "${RED}Failed bash check${OFF}" && ((fails++)))
  x.check.go || (echo "${RED}Failed go check${OFF}" && ((fails++)))
  x.check.java || (echo "${RED}Failed java check${OFF}" && ((fails++)))
  x.check.curl || (echo "${RED}Failed curl check${OFF}" && ((fails++)))
  x.check.docker || (echo "${RED}Failed docker check${OFF}" && ((fails++)))
  x.check.docker-compose || (echo "${RED}Failed docker-compose check${OFF}" && ((fails++)))
  x.check.direnv || (echo "${RED}Failed direnv check${OFF}" && ((fails++)))
  ((fails == 0)) && echo "${GREEN}ðŸŽ‰ All build dependencies met${OFF}"
}

x.check.bash() {
  ((${BASH_VERSION:0:1} >= 4)) &&
    printf "%-30s âœ…\n" "Bash: ${BASH_VERSION:0:1}"
}

x.check.curl() {
  local -a versa
  mapfile versa < <(curl -V 2>&1)
  if [[ "${versa[0]}" =~ ^[^\ ]+\ ([^\ ]+) ]]; then
    printf "%-30s âœ…\n" "Curl: ${BASH_REMATCH[1]}"
    return 0
  else
    return 1
  fi
}

x.check.go() {
  local vers
  vers=$(go version)
  [[ "$vers" =~ ^[^\ ]+\ [^\ ]+\ go1\.([^\ \.]+) ]] &&
    ((BASH_REMATCH[1] >= 18)) &&
    printf "%-30s âœ…\n" "Go: ${BASH_REMATCH[1]}"
}

x.check.docker() {
  local vers
  vers=$(docker --version)
  [[ "$vers" =~ version[\ ]+([^\ \.]+) ]] &&
    ((BASH_REMATCH[1] >= 20)) &&
    printf "%-30s âœ…\n" "Docker: ${BASH_REMATCH[1]}"
}

x.check.docker-compose() {
  local vers
  vers=$(docker-compose version)
  [[ "$vers" =~ [\ ]+v([0-9]+)[\.]{1} ]] &&
    ((BASH_REMATCH[1] >= 2)) &&
    printf "%-30s âœ…\n" "Docker Compose: ${BASH_REMATCH[1]}"
}

x.check.direnv() {
  local vers
  vers=$(direnv --version)
  [[ "$vers" =~ ([0-9]+)[\.]{1} ]] &&
    ((BASH_REMATCH[1] >= 2)) &&
    printf "%-30s âœ…\n" "Direnv: ${BASH_REMATCH[1]}"
}

x.check.java() {
  local jvers
  jvers=$(java -version 2>&1 | head -1)
  jvers=${jvers#*version \"}
  jvers=${jvers%%\"*}
  if [[ 
    $jvers =~ ^(1\.[89]|9\.|[1-9][0-9]+) ]]; then
    printf "%-30s âœ…\n" "Java: $jvers"
    return 0
  else
    return 1
  fi
}

#################

x.bootstrap() {
  x.check.build-deps
  x.install-tools
  x.fetch-openapi-generator-jar
  x.download-swagger-ui
}

x.install-go-tools() {
  set -o errexit -eo pipefail

  go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@v4.15.2
  go install github.com/kyleconroy/sqlc/cmd/sqlc@v1.15.0
  go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.47.2
  go install github.com/joho/godotenv/cmd/godotenv@latest
  go install github.com/danicc097/air@v0.1
  go install github.com/xo/xo@latest

  GO111MODULE=off go get -u github.com/maxbrunsfeld/counterfeiter
}

x.fetch-openapi-generator-jar() {
  local url="https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/$GENVERS/openapi-generator-cli-$GENVERS.jar"
  echo "$url > openapi-generator-cli.jar"
  curl -L "$url" -o openapi-generator-cli.jar
}

x.validate() {
  java -jar openapi-generator-cli.jar validate -i "${1:-$SPEC}"
}

x.openapi-generator() {
  local spec="$1"
  local gen_out_dir="$2"
  local template_dir="$3"

  [[ -z $spec ]] && echo "generate-api: spec required" && exit 1
  [[ -z $gen_out_dir ]] && echo "generate-api: out dir required" && exit 1
  [[ -z $template_dir ]] && echo "generate-api: template dir required" && exit 1
  echo "Generating API from $spec"
  echo "Generation directory: $gen_out_dir"
  echo "Template override directory: $template_dir"

  rm -rf "$gen_out_dir/gen"
  # debug has a very small overhead compared to the >1s required per spec
  java -jar "$BIN_DIR"/../openapi-generator-cli.jar generate \
    -g go-gin-server \
    -i "$spec" \
    -o "$gen_out_dir" \
    -t "$template_dir" \
    --additional-properties=packageName=openapi,apiPath=gen,hideGenerationTimestamp=true \
    --enable-post-process-file \
    --global-property=debugModels,debugOperations >debug-openapi.log #>/dev/null \

  mkdir -p "$gen_out_dir"/gen/models
  mkdir -p "$gen_out_dir"/handlers
  mkdir -p "$gen_out_dir"/services
  mkdir -p "$gen_out_dir"/rest
  mv "$gen_out_dir"/gen/routers.go "$gen_out_dir"/rest
  mv "$gen_out_dir"/gen/model_*.go "$gen_out_dir"/gen/models 2>/dev/null || echo "No model files found. Skipping"
  rm -rf "$gen_out_dir/api"
}

# NOTE: jar won't output properly if absolute paths are passed from subdir
x.generate-tests-api() {
  local testdata="$BIN_DIR/../tests/testdata/postgen/openapi_generator"
  local test_dirs=$(find "$testdata" -maxdepth 1 -mindepth 1 -type d -exec basename {} \;)

  cache=".generate-tests-api.cache"
  tpl_changed=false
  mkdir -p "$cache"
  if ! md5sum -c "$cache/openapi_generator-go-gin-server-templates.md5"; then
    md5sum "$BIN_DIR"/../internal/go-gin-server-templates/* >"$cache/openapi_generator-go-gin-server-templates.md5"
    tpl_changed=true
  fi

  for test_dir in $test_dirs; do
    if [[ $tpl_changed == false ]] && md5sum -c "$cache/openapi_generator-$test_dir-openapi.md5"; then
      continue
    fi
    md5sum "$testdata/$test_dir/openapi.yaml" >"$cache/openapi_generator-$test_dir-openapi.md5"
    mkdir -p "$testdata/$test_dir/internal"
    x.openapi-generator \
      "$testdata/$test_dir/openapi.yaml" \
      "$testdata/$test_dir/internal" \
      "$BIN_DIR/../internal/go-gin-server-templates"
  done
}

# TODO force gen flag
x.generate-api() {
  cache=".generate-api.cache"
  invalid_cache=false
  mkdir -p "$cache"
  if ! md5sum -c "$cache/go-gin-server-templates.md5" >/dev/null; then
    md5sum "$BIN_DIR"/../internal/go-gin-server-templates/* >"$cache/go-gin-server-templates.md5"
    invalid_cache=true
  fi
  if ! md5sum -c "$cache/openapi.md5" >/dev/null; then
    md5sum "$BIN_DIR"/../openapi.yaml >"$cache/openapi.md5"
    invalid_cache=true
  fi
  [[ $invalid_cache == true ]] && x.openapi-generator \
    "$SPEC" \
    "$GEN_OUT_DIR" \
    "$TEMPLATE_DIR"
  go build -o postgen "$PWD"/cmd/postgen/main.go
  POSTGEN_CACHE="$cache" ./postgen
  mv "$GEN_OUT_DIR"/gen/api_*.go "$cache/" 2>/dev/null || true
}

x.generate-sqlc() {
  bin/scripts/sql-format.sh
  cd internal/postgresql && sqlc generate && cd - || exit
}

# automatic crud + queries based on existing indexes
# does not work with a schema file. Must be run after x.migrate
x.generate-xo-crud() {
  (
    source "$ENV_FILE"
    mkdir -p internal/postgresql/gen/crud
    xo schema "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_SERVER:$DB_PORT/$POSTGRES_DB?sslmode=disable" \
      -o internal/postgresql/gen/crud
  )
}

x.sync-swagger-ui() {
  cp internal/static/swagger-override/swagger-initializer.js internal/static/swagger-ui/
  cp "$SPEC" "$PWD"/internal/static/swagger-ui
}

x.generate-counterfeiter() {
  counterfeiter -o internal/envvar/envvartesting/provider.gen.go internal/envvar/envvar.go Provider
}

x.generate() {
  go generate ./...
  x.generate-counterfeiter
  x.generate-api "$SPEC" "$GEN_OUT_DIR" "$GEN_OUT_DIR/go-gin-server-templates"
  x.generate-sqlc
  x.generate-xo-crud
  x.sync-swagger-ui
}

x.compose-up() {
  docker-compose up -d
}

x.test() {
  x.compose-up
  x.generate
  create_test_database
  godotenv -f "$ENV_FILE" go test ./... "$@"
}

x.build() {
  x.test ""
  go build -o openapi-go-gin-postgres-sqlc "$PWD"/cmd/rest-server
}

x.run() {
  x.build
  ./openapi-go-gin-postgres-sqlc -env="$ENV_FILE"
}

x.run-hot-reload() {
  x.compose-up
  air \
    --build.pre_build_cmd "bin/build generate" \
    --build.cmd "go build -o ./air-main ./cmd/rest-server/" \
    --build.bin "./air-main -env=$ENV_FILE" \
    --build.exclude_regex ".gen.go,internal/gen/*,internal/postgresql/gen/*,testdata,_test.go" \
    --build.stop_watch "internal/handlers/,internal/services/" \
    --build.delay 1000
}

x.download-swagger-ui() {
  name="$(curl --silent "https://api.github.com/repos/swagger-api/swagger-ui/releases/latest" | jq -r ".. .tag_name? // empty")"
  curl -fsSL "github.com/swagger-api/swagger-ui/archive/refs/tags/$name.tar.gz" -o swagger-ui.tar.gz
  tar xf swagger-ui.tar.gz swagger-ui-"${name#*v}"/dist --one-top-level=swagger-ui --strip-components=2
  rm swagger-ui.tar.gz
  mkdir -p internal/static/swagger-ui
  mv swagger-ui/* internal/static/swagger-ui/
  rm -r swagger-ui
}

x.migrate() {
  (
    source "$ENV_FILE"
    migrate \
      -path db/migrations/ \
      -database "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_SERVER:$DB_PORT/$POSTGRES_DB?sslmode=disable" \
      "$@"
  )
}

x.create-migration() {
  name="$*"
  tmp="${name// /_}"
  tmp="${tmp,,}"
  x.migrate create -ext sql -dir db/migrations/ "$tmp"
}

create_test_database() {
  (
    source "$ENV_FILE"

    local postgres_test_db="${POSTGRES_DB}_test"

    drop_db "$postgres_test_db" .env

    echo "${BLUE}${BOLD}Stopping any running processes for database $postgres_test_db.${OFF}"
    docker exec -t postgres_db_"$PROJECT_PREFIX"_"$APP_ENV" \
      psql --no-psqlrc \
      -U "$POSTGRES_USER" \
      -d "$POSTGRES_DB" \
      -c "select pg_terminate_backend(pid) \
        from pg_stat_activity \
        where datname='$postgres_test_db'"
  )
}

# --------------------- completion and delegation --------------------
#      `complete -C foo foo` > `source <(foo bloated_completion)`

while IFS= read -r line; do
  [[ $line =~ ^declare\ -f\ x\. ]] || continue
  COMMANDS+=("${line##declare -f x.}")
done < <(declare -F)
mapfile -t COMMANDS < \
  <(LC_COLLATE=C sort < <(printf "%s\n" "${COMMANDS[@]}"))

if [[ -n $COMP_LINE ]]; then
  line=${COMP_LINE#* }
  for c in "${COMMANDS[@]}"; do
    [[ ${c:0:${#line}} == "${line,,}" ]] && echo "$c"
  done
  exit
fi

for c in "${COMMANDS[@]}"; do
  if [[ $c == "$EXE" ]]; then
    "x.$EXE" "$@"
    exit $?
  fi
done

if [[ -n "$1" ]]; then
  declare CMD="$1"
  shift
  for c in "${COMMANDS[@]}"; do
    declare cmd=$(command -v "x.$c")
    if [[ $c == "$CMD" && -n "$cmd" ]]; then
      "x.$CMD" "$@"
      exit $?
    fi
  done
fi
